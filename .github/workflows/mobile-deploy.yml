name: Mobile Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to build for
        required: true
        type: choice
        options:
          - production
          - preview
  workflow_call:
    inputs:
      environment:
        description: Environment to build for
        required: true
        type: string

defaults:
  run:
    working-directory: 'apps/mobile'

concurrency:
  cancel-in-progress: true
  group: ${{ inputs.environment }}-mobile-deploy

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ios
            name: iOS
            os: macos-latest
          - platform: android
            name: Android
            os: ubuntu-latest

    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    environment: ${{ inputs.environment }}
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm add --global eas-cli
      - id: build
        run: |
          pnpm build:${{ matrix.platform }} --profile ${{ inputs.environment }}
          echo "artifact-path=$(realpath build/*)" >> $GITHUB_OUTPUT
      - run: ls build/*
      - id: diawi
        if: inputs.environment == 'preview'
        uses: rnkdsh/action-upload-diawi@v1.5.9
        with:
          token: ${{ secrets.DIAWI_TOKEN }}
          file: ${{ steps.build.outputs.artifact-path }}
      - name: Job Summary
        if: inputs.environment == 'preview'
        run: |
          echo '## ${{ matrix.name }} App' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.diawi.outputs.url }}' >> $GITHUB_STEP_SUMMARY
          echo '![QR Code](${{ steps.diawi.outputs.qrcode }})' >> $GITHUB_STEP_SUMMARY

  push-update:
    name: Push Update
    runs-on: macos-latest
    environment: ${{ inputs.environment }}
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm add --global eas-cli
      - run: eas env:pull ${{ inputs.environment }} --non-interactive
      - run: eas update --auto --non-interactive --environment ${{ inputs.environment }}
      - run: dotenvx run --convention nextjs -- pnpx sentry-expo-upload-sourcemaps dist

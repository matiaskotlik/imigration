name: Mobile Build

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment to build for
        required: true
        type: choice
        options:
          - production
          - preview
  workflow_call:
    inputs:
      environment:
        description: Environment to build for
        required: true
        type: string

defaults:
  run:
    working-directory: 'apps/mobile'

concurrency:
  cancel-in-progress: true
  group: ${{ inputs.environment }}-mobile-build

jobs:
  ios:
    name: iOS
    runs-on: macos-latest
    environment: ${{ inputs.environment }}

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm add --global eas-cli
      - run: >
          NODE_OPTIONS="--openssl-legacy-provider --max_old_space_size=4096"
          eas build
          --local
          --non-interactive
          --platform ios
          --profile ${{ inputs.environment }}
          --output imigration.ipa
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      - run: >
          curl https://upload.diawi.com/
            -F token='${{ secrets.DIAWI_TOKEN }}'
            -F file=@imigration.ipa
            -F find_by_udid=1
            -F comment="$(git log -1 --pretty=reference)"
          | jq -r '"https://i.diawi.com/\(.job)"'

  update:
    name: Update
    runs-on: macos-latest
    environment: ${{ inputs.environment }}

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm add --global eas-cli
      - run: eas update --auto --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
